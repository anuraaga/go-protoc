diff --git a/upb/json/decode.c b/upb/json/decode.c
index 8fe655ccf..ea12912c0 100644
--- a/upb/json/decode.c
+++ b/upb/json/decode.c
@@ -12,7 +12,6 @@
 #include <inttypes.h>
 #include <limits.h>
 #include <math.h>
-#include <setjmp.h>
 #include <stdarg.h>
 #include <stddef.h>
 #include <stdint.h>
diff --git a/upb/json/encode.c b/upb/json/encode.c
index c152393ca..66aa77f03 100644
--- a/upb/json/encode.c
+++ b/upb/json/encode.c
@@ -47,7 +47,7 @@ static void jsonenc_value(jsonenc* e, const upb_Message* msg,
 
 UPB_NORETURN static void jsonenc_err(jsonenc* e, const char* msg) {
   upb_Status_SetErrorMessage(e->status, msg);
-  longjmp(e->err, 1);
+  UPB_LONGJMP(e->err, 1);
 }
 
 UPB_PRINTF(2, 3)
@@ -56,7 +56,7 @@ UPB_NORETURN static void jsonenc_errf(jsonenc* e, const char* fmt, ...) {
   va_start(argp, fmt);
   upb_Status_VSetErrorFormat(e->status, fmt, argp);
   va_end(argp);
-  longjmp(e->err, 1);
+  UPB_LONGJMP(e->err, 1);
 }
 
 static upb_Arena* jsonenc_arena(jsonenc* e) {
diff --git a/upb/port/def.inc b/upb/port/def.inc
index 19ac51f12..9ea36697c 100644
--- a/upb/port/def.inc
+++ b/upb/port/def.inc
@@ -43,7 +43,6 @@
 #endif
 
 #include <assert.h>
-#include <setjmp.h>
 #include <stdbool.h>
 #include <stdint.h>
 #include <stdio.h>
@@ -176,8 +175,9 @@ Error, UINTPTR_MAX is undefined
 #define UPB_SETJMP(buf) _setjmp(buf)
 #define UPB_LONGJMP(buf, val) _longjmp(buf, val)
 #else
-#define UPB_SETJMP(buf) setjmp(buf)
-#define UPB_LONGJMP(buf, val) longjmp(buf, val)
+typedef void* jmp_buf;
+#define UPB_SETJMP(buf) 0
+#define UPB_LONGJMP(buf, val) 0
 #endif
 
 #ifdef __GNUC__
diff --git a/upb/util/required_fields.c b/upb/util/required_fields.c
index c3723863c..b453cd151 100644
--- a/upb/util/required_fields.c
+++ b/upb/util/required_fields.c
@@ -9,7 +9,6 @@
 
 #include <assert.h>
 #include <inttypes.h>
-#include <setjmp.h>
 #include <stdarg.h>
 #include <stdbool.h>
 #include <stddef.h>
diff --git a/upb/wire/encode.c b/upb/wire/encode.c
index 5764199e4..6d8241f57 100644
--- a/upb/wire/encode.c
+++ b/upb/wire/encode.c
@@ -9,7 +9,6 @@
 
 #include "upb/wire/encode.h"
 
-#include <setjmp.h>
 #include <stdbool.h>
 #include <stdint.h>
 #include <string.h>
